<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WhatsApp Chat</title>
  <style>
    :root{
      --wa-green:#008069;
      --bg:#0b141a;
      --panel:#111b21;
      --panel2:#202c33;
      --text:#e9edef;
      --muted:#8696a0;
      --bubble-me:#005c4b;
      --bubble-you:#202c33;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;justify-content:center}
    .app{width:min(980px,100%);height:100vh;display:flex;background:var(--panel)}
    .left{width:360px;max-width:100%;border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column}
    .topbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:var(--panel2)}
    .meRow{display:flex;align-items:center;gap:10px}
    .avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;background:#333}
    .title{font-weight:700}
    .search{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search input{width:100%;padding:10px 12px;border-radius:10px;border:0;outline:0;background:#111f26;color:var(--text)}
    .list{flex:1;overflow:auto}
    .chatRow{display:flex;gap:12px;padding:10px 12px;cursor:pointer}
    .chatRow:hover{background:rgba(255,255,255,.03)}
    .chatRow.active{background:rgba(255,255,255,.06)}
    .chatMeta{flex:1;min-width:0}
    .rowTop{display:flex;justify-content:space-between;gap:10px}
    .name{font-weight:700}
    .time{color:var(--muted);font-size:12px}
    .preview{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}

    .right{flex:1;display:flex;flex-direction:column}
    .chatHeader{height:56px;display:flex;align-items:center;gap:10px;padding:0 12px;background:var(--panel2)}
    .backBtn{display:none;background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer}
    .chatInfo{display:flex;flex-direction:column;line-height:1.1}
    .online{color:var(--muted);font-size:12px}

    .msgs{flex:1;overflow:auto;padding:14px 12px;background:#0f1a20}
    .bubble{max-width:78%;padding:10px 12px;border-radius:14px;margin:6px 0;white-space:pre-wrap;word-wrap:break-word}
    .me{margin-left:auto;background:var(--bubble-me)}
    .you{margin-right:auto;background:var(--bubble-you)}
    .tick{font-size:11px;color:rgba(255,255,255,.6);margin-top:4px;text-align:right}
    .inputBar{height:60px;display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--panel2)}
    .inputBar input{flex:1;padding:12px 14px;border-radius:999px;border:0;outline:0;background:#111f26;color:var(--text)}
    .send{background:var(--wa-green);border:0;color:white;border-radius:999px;padding:12px 14px;cursor:pointer;font-weight:700}

    @media (max-width:820px){
      .left{width:100%}
      .right{display:none}
      .app.mobileChat .left{display:none}
      .app.mobileChat .right{display:flex}
      .backBtn{display:inline}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="left">
      <div class="topbar">
        <div class="meRow">
          <img class="avatar" src="/avatar-default.jpg" alt="">
          <div class="title">Sohbetler</div>
        </div>
        <div style="color:var(--muted);font-size:12px">online</div>
      </div>

      <div class="search">
        <input id="q" placeholder="Ara..." />
      </div>

      <div class="list" id="list"></div>
    </aside>

    <main class="right">
      <div class="chatHeader">
        <button class="backBtn" id="back">←</button>
        <img class="avatar" id="headAva" src="/avatar-default.jpg" alt="">
        <div class="chatInfo">
          <div class="name" id="headName">—</div>
          <div class="online" id="headOnline">çevrimiçi</div>
        </div>
      </div>

      <div class="msgs" id="msgs"></div>

      <div class="inputBar">
        <input id="msgInput" placeholder="Mesaj yaz" />
        <button class="send" id="sendBtn">Gönder</button>
      </div>
    </main>
  </div>

<script>
  const app = document.getElementById("app");
  const listEl = document.getElementById("list");
  const msgsEl = document.getElementById("msgs");
  const headName = document.getElementById("headName");
  const headAva = document.getElementById("headAva");
  const headOnline = document.getElementById("headOnline");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const backBtn = document.getElementById("back");
  const q = document.getElementById("q");

  const AVA = {
    fatik: "/avatar-fatik.jpg",
    anne: "/avatar-anne.jpg",
    sevval: "/avatar-sevval.jpg",
    asros: "/avatar-asros.jpg",
    oe1: "/avatar-oe.jpg",
    oe2: "/avatar-oe.jpg",
    oe3: "/avatar-oe.jpg",
    default: "/avatar-default.jpg"
  };

  const chats = [
    { id:"fatik", name:"Fatik", preview:"", time:"" },
    { id:"sevval", name:"Şevval", preview:"aşkoooo", time:"" },
    { id:"anne", name:"Anneeeyyy", preview:"Fatih oğlumu üzersen…", time:"" },
    { id:"asros", name:"Asroşşşş", preview:"Toktikten video attım…", time:"" },
    { id:"oe1", name:"Oe1", preview:"Fatih abim kraldır", time:"" },
    { id:"oe2", name:"Oe2", preview:"Fatih abime saygılar", time:"" },
    { id:"oe3", name:"Oe3", preview:"Abime yanlış yapılmaz", time:"" },
  ];

  let currentChatId = "fatik";
  const storeKey = (id) => `chat_${id}_messages`;

  function nowTime(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function getAvatar(id){
    return AVA[id] || AVA.default;
  }

  function loadMsgs(chatId){
    try { return JSON.parse(localStorage.getItem(storeKey(chatId)) || "[]"); }
    catch { return []; }
  }

  function saveMsgs(chatId, arr){
    localStorage.setItem(storeKey(chatId), JSON.stringify(arr.slice(-60)));
  }

  function renderList(){
    const term = (q.value||"").toLowerCase();
    listEl.innerHTML = "";
    chats
      .filter(c => c.name.toLowerCase().includes(term))
      .forEach(c=>{
        const row = document.createElement("div");
        row.className = "chatRow" + (c.id===currentChatId ? " active":"");
        const ava = getAvatar(c.id);
        row.innerHTML = `
          <img class="avatar" src="${ava}" onerror="this.src='${AVA.default}'" alt="">
          <div class="chatMeta">
            <div class="rowTop">
              <div class="name">${escapeHtml(c.name)}</div>
              <div class="time">${escapeHtml(c.time||"")}</div>
            </div>
            <div class="preview">${escapeHtml(c.preview||"")}</div>
          </div>
        `;
        row.onclick = ()=>openChat(c.id);
        listEl.appendChild(row);
      });
  }

  function renderMsgs(chatId){
    const arr = loadMsgs(chatId);
    msgsEl.innerHTML = arr.map(m=>{
      const cls = m.role==="me" ? "bubble me" : "bubble you";
      const tick = m.time ? `<div class="tick">${escapeHtml(m.time)}</div>` : "";
      return `<div class="${cls}">${escapeHtml(m.text)}${tick}</div>`;
    }).join("");
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }

  function setHeader(chatId){
    const c = chats.find(x=>x.id===chatId);
    headName.textContent = c ? c.name : "—";
    headAva.src = getAvatar(chatId);
    headAva.onerror = ()=> headAva.src = AVA.default;
    headOnline.textContent = "çevrimiçi";
  }

  function updatePreview(chatId, text){
    const c = chats.find(x=>x.id===chatId);
    if(!c) return;
    c.preview = text;
    c.time = nowTime();
    renderList();
  }

  function pushMsg(chatId, role, text){
    const arr = loadMsgs(chatId);
    arr.push({ role, text, time: nowTime() });
    saveMsgs(chatId, arr);
    renderMsgs(chatId);
    updatePreview(chatId, role==="me" ? text : text);
  }

  async function aiSend(chatId, userText){
    // typing hissi
    headOnline.textContent = "yazıyor…";
    const history = loadMsgs(chatId).map(m => ({ role: m.role, text: m.text })).slice(-12);

    const res = await fetch("/.netlify/functions/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        chatId,
        message: userText || "",
        history
      })
    });

    const data = await res.json().catch(()=>({ ok:false, reply:"Sunucu cevap veremedi" }));
    headOnline.textContent = "çevrimiçi";

    const reply = (data.reply || "").trim();
    if(reply){
      pushMsg(chatId, "you", reply);
    }
  }

  async function openChat(chatId){
    currentChatId = chatId;
    setHeader(chatId);
    renderList();
    renderMsgs(chatId);

    // mobil görünüm
    if(window.matchMedia("(max-width:820px)").matches){
      app.classList.add("mobileChat");
    }

    // ✅ AI ilk adımı atsın: sohbet boşsa otomatik başlat
    const arr = loadMsgs(chatId);
    if(arr.length === 0){
      await aiSend(chatId, ""); // boş gönderiyoruz, backend “başlat” yapıyor
    }
  }

  sendBtn.onclick = async ()=>{
    const txt = (msgInput.value||"").trim();
    if(!txt) return;
    msgInput.value="";
    pushMsg(currentChatId, "me", txt);
    await aiSend(currentChatId, txt);
  };

  msgInput.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") sendBtn.click();
  });

  backBtn.onclick = ()=>{
    app.classList.remove("mobileChat");
  };

  q.addEventListener("input", renderList);

  // Başlat
  renderList();
  openChat("fatik");
</script>
</body>
</html>
